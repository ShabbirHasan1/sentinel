name: Manual Documentation Deployment

on:
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message'
        required: false
        default: 'Manual documentation deployment'
        type: string
      mdbook_version:
        description: 'mdBook version to use'
        required: false
        default: '0.4.37'
        type: string
      install_plugins:
        description: 'Install optional mdBook plugins'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (build only, no deployment)'
        required: false
        default: false
        type: boolean

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages-manual"
  cancel-in-progress: true

jobs:
  # Build and optionally deploy documentation
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.dry_run == 'true' && 'dry-run' || 'github-pages' }}
      url: ${{ github.event.inputs.dry_run == 'true' && '' || steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Display deployment parameters
        run: |
          echo "## ðŸ“š Manual Documentation Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Parameters:" >> $GITHUB_STEP_SUMMARY
          echo "- **Message:** ${{ github.event.inputs.deploy_message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **mdBook Version:** ${{ github.event.inputs.mdbook_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Install Plugins:** ${{ github.event.inputs.install_plugins }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v1
        with:
          mdbook-version: ${{ github.event.inputs.mdbook_version }}

      - name: Setup Rust (for plugins)
        if: github.event.inputs.install_plugins == 'true'
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: cargo

      - name: Cache mdBook plugins
        if: github.event.inputs.install_plugins == 'true'
        uses: actions/cache@v3
        id: mdbook-plugins-cache
        with:
          path: ~/.cargo/bin
          key: mdbook-plugins-${{ runner.os }}-manual-${{ hashFiles('book/book.toml') }}
          restore-keys: |
            mdbook-plugins-${{ runner.os }}-manual-
            mdbook-plugins-${{ runner.os }}-

      - name: Install mdBook plugins
        if: github.event.inputs.install_plugins == 'true'
        run: |
          echo "Installing optional mdBook plugins..."

          # List of plugins to install
          plugins=(
            "mdbook-mermaid"
            "mdbook-admonish"
            "mdbook-linkcheck"
            "mdbook-toc"
            "mdbook-katex"
          )

          for plugin in "${plugins[@]}"; do
            if ! command -v "$plugin" &> /dev/null; then
              echo "Installing $plugin..."
              cargo install "$plugin" --locked || echo "Warning: Failed to install $plugin"
            else
              echo "$plugin is already installed"
            fi
          done

          echo "Plugin installation complete"

      - name: Validate book.toml
        working-directory: ./book
        run: |
          echo "Validating book.toml configuration..."
          if ! mdbook build --dry-run 2>&1 | grep -q "error"; then
            echo "âœ… book.toml is valid"
          else
            echo "âš ï¸ Potential issues in book.toml"
            mdbook build --dry-run || true
          fi

      - name: Build documentation
        working-directory: ./book
        run: |
          echo "Building documentation..."
          mdbook build

          # Get build statistics
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML files:** $(find book -name "*.html" -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total size:** $(du -sh book | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Chapters:** $(grep -c '^-' src/SUMMARY.md || echo 0)" >> $GITHUB_STEP_SUMMARY

      - name: Test documentation
        working-directory: ./book
        run: |
          echo "Testing documentation..."
          mdbook test
          echo "âœ… Documentation tests passed"

      - name: Check for broken links
        if: github.event.inputs.install_plugins == 'true'
        working-directory: ./book
        continue-on-error: true
        run: |
          if command -v mdbook-linkcheck &> /dev/null; then
            echo "Checking for broken links..."
            mdbook-linkcheck || echo "âš ï¸ Some links may be broken"
          else
            echo "mdbook-linkcheck not installed, skipping link check"
          fi

      - name: Create deployment artifact
        run: |
          # Add metadata file
          cat > book/book/.deployment-info.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "message": "${{ github.event.inputs.deploy_message }}",
            "mdbook_version": "${{ github.event.inputs.mdbook_version }}",
            "plugins_installed": ${{ github.event.inputs.install_plugins }}
          }
          EOF

      - name: Upload artifact for dry run
        if: github.event.inputs.dry_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: documentation-manual-${{ github.run_number }}
          path: ./book/book
          retention-days: 30

      - name: Upload Pages artifact
        if: github.event.inputs.dry_run == 'false'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./book/book

      - name: Deploy to GitHub Pages
        if: github.event.inputs.dry_run == 'false'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Status:" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "âœ… **Dry run completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Documentation was built but not deployed." >> $GITHUB_STEP_SUMMARY
            echo "Download the artifact to review the build output." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Documentation deployed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— Access Documentation:" >> $GITHUB_STEP_SUMMARY

            # Determine the documentation URL
            REPO="${{ github.repository }}"
            OWNER="${{ github.repository_owner }}"
            REPO_NAME="${REPO#*/}"

            if [[ "$REPO_NAME" == "${OWNER}.github.io" ]]; then
              DOC_URL="https://${OWNER}.github.io/"
            else
              DOC_URL="https://${OWNER}.github.io/${REPO_NAME}/"
            fi

            echo "- **URL:** $DOC_URL" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployment ID:** \`${{ steps.deployment.outputs.deployment_id || 'N/A' }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ _It may take a few minutes for changes to be visible._" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueTitle = `Documentation deployment failed - ${new Date().toISOString().split('T')[0]}`;
            const issueBody = `## Documentation Deployment Failed

            **Workflow:** Manual Documentation Deployment
            **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Triggered by:** @${{ github.actor }}
            **Message:** ${{ github.event.inputs.deploy_message }}

            ### Parameters:
            - mdBook Version: ${{ github.event.inputs.mdbook_version }}
            - Install Plugins: ${{ github.event.inputs.install_plugins }}
            - Dry Run: ${{ github.event.inputs.dry_run }}

            Please check the workflow logs for details.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['documentation', 'deployment-failure']
            });
