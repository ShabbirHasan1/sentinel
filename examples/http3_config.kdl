// Sentinel HTTP/3 Configuration Example
// This demonstrates how to enable HTTP/3 with QUIC transport
// Note: HTTP/3 support requires TLS 1.3 and operates over UDP

server {
    worker_threads 4
    max_connections 10000
    graceful_shutdown_timeout_secs 30
}

// HTTP/3 Listeners
listeners {
    // HTTP/1.1 and HTTP/2 listener (TCP)
    listener "https" {
        address "0.0.0.0:443"
        protocol "https"

        tls {
            cert_file "/etc/sentinel/certs/server.crt"
            key_file "/etc/sentinel/certs/server.key"
            min_version "TLSv1.2"
            max_version "TLSv1.3"

            // Enable ALPN for HTTP/2
            alpn_protocols ["h2", "http/1.1"]

            ocsp_stapling true
            session_resumption true
        }

        // Advertise HTTP/3 support via Alt-Svc header
        alt_svc {
            enabled true
            h3_port 443
            max_age 86400  // 24 hours
            include_draft_versions false
            persist true
        }
    }

    // HTTP/3 listener (QUIC/UDP)
    listener "http3" {
        address "0.0.0.0:443"
        protocol "h3"

        // TLS configuration (required for QUIC)
        tls {
            cert_file "/etc/sentinel/certs/server.crt"
            key_file "/etc/sentinel/certs/server.key"

            // HTTP/3 requires TLS 1.3
            min_version "TLSv1.3"
            max_version "TLSv1.3"

            // ALPN for HTTP/3
            alpn_protocols ["h3", "h3-29"]  // Include draft versions if needed

            // TLS 1.3 cipher suites
            cipher_suites [
                "TLS_AES_128_GCM_SHA256"
                "TLS_AES_256_GCM_SHA384"
                "TLS_CHACHA20_POLY1305_SHA256"
            ]

            ocsp_stapling true
            session_resumption true

            // 0-RTT (early data) configuration
            early_data {
                enabled true
                max_size 16384  // 16KB

                // Anti-replay protection
                replay_protection true
                replay_cache_size 10000
                replay_window_secs 60
            }
        }

        // QUIC transport configuration
        quic {
            // Connection parameters
            max_idle_timeout_ms 30000  // 30 seconds
            initial_rtt_ms 333  // Initial RTT estimate

            // Flow control
            initial_max_data 10485760  // 10MB
            initial_max_stream_data_bidi_local 1048576  // 1MB
            initial_max_stream_data_bidi_remote 1048576  // 1MB
            initial_max_stream_data_uni 1048576  // 1MB

            // Stream limits
            initial_max_streams_bidi 100
            initial_max_streams_uni 100

            // Packet configuration
            max_udp_payload_size 1350  // Conservative for IPv4
            ack_delay_exponent 3
            max_ack_delay_ms 25

            // Connection migration
            migration {
                enabled true
                // Allow connection migration between different network paths
                allow_network_change true
                // Validate new paths before switching
                path_validation true
            }

            // Congestion control
            congestion_control "cubic"  // Options: cubic, bbr, new_reno

            // Loss detection
            loss_detection {
                packet_threshold 3
                time_threshold 1.125  // 9/8
                initial_probe_timeout_ms 500
            }

            // DATAGRAM frames (for future WebTransport support)
            enable_datagram false

            // Keep-alive
            keep_alive {
                enabled true
                interval_secs 15
                timeout_secs 60
            }
        }

        // HTTP/3 specific settings
        http3 {
            // Header compression (QPACK)
            qpack {
                max_table_capacity 16384  // 16KB
                blocked_streams 100
                // Dynamic table size
                max_dynamic_table_size 4096
            }

            // Maximum sizes
            max_header_list_size 16384  // 16KB
            max_field_section_size 16384  // 16KB

            // WebTransport support
            webtransport {
                enabled true
                max_sessions 100
                // WebTransport over HTTP/3 draft version
                draft_version "draft02"
            }

            // Extended CONNECT for proxying
            enable_extended_connect true

            // Server push (being deprecated but still configurable)
            server_push {
                enabled false
                max_concurrent_streams 0
            }
        }

        // Performance optimizations
        performance {
            // GSO (Generic Segmentation Offload)
            enable_gso true
            gso_max_size 65536

            // Receive buffer size
            recv_buffer_size 2097152  // 2MB

            // Send buffer size
            send_buffer_size 2097152  // 2MB

            // CPU affinity for QUIC processing
            cpu_affinity true

            // Batch packet processing
            batch_size 16
        }

        // Connection limits
        limits {
            max_concurrent_connections 100000
            max_concurrent_streams_per_connection 1000
            max_requests_per_connection 10000

            // Rate limiting
            new_connection_rate_limit 1000  // per second

            // Amplification attack protection
            amplification_limit 3  // 3x amplification max before address validation
        }
    }

    // HTTP/1.1 fallback listener
    listener "http" {
        address "0.0.0.0:80"
        protocol "http"

        // Redirect to HTTPS with Alt-Svc
        default_action {
            redirect {
                scheme "https"
                status_code 301
                include_alt_svc true
            }
        }
    }
}

// Routes configuration (works with all protocols)
routes {
    // High-performance API route
    route "api-v2" {
        id "api-v2-route"
        priority 100
        service_type "api"

        matches {
            host "api.example.com"
            path_prefix "/v2"
        }

        upstream "api-backend"

        // Protocol-specific optimizations
        protocol_optimizations {
            // HTTP/3 specific
            h3 {
                // Prioritization
                priority {
                    urgency 3  // 0-7, lower is more urgent
                    incremental true
                }

                // Stream reset on timeout
                reset_stream_on_timeout true
            }

            // HTTP/2 specific
            h2 {
                // Server push resources
                push_resources [
                    "/api/v2/schema.json"
                    "/api/v2/docs.json"
                ]
            }
        }

        policies {
            timeout_secs 10
            max_body_size "5MB"
        }
    }

    // WebTransport endpoint
    route "webtransport" {
        id "webtransport-route"
        priority 95
        service_type "web"

        matches {
            path "/webtransport"
            header {
                name ":protocol"
                value "webtransport"
            }
        }

        upstream "webtransport-backend"

        // WebTransport specific configuration
        webtransport {
            // Session configuration
            max_sessions_per_client 10
            session_timeout_secs 3600

            // Stream limits
            max_bidirectional_streams 100
            max_unidirectional_streams 100

            // Datagram support
            enable_datagrams true
            max_datagram_size 1200
        }
    }

    // Static content optimized for HTTP/3
    route "static-h3" {
        id "static-h3-route"
        priority 80
        service_type "static"

        matches {
            host "cdn.example.com"
        }

        upstream null

        static_files {
            root "/var/www/cdn"

            // Aggressive caching for HTTP/3
            cache_control "public, max-age=31536000, immutable"

            // Enable compression
            compress true
            compression_level 6

            // Preload resources for HTTP/3 0-RTT
            preload {
                enabled true
                resources [
                    "/css/main.css"
                    "/js/app.js"
                    "/fonts/main.woff2"
                ]
            }
        }

        // 0-RTT configuration for this route
        zero_rtt {
            enabled true
            // Only allow safe methods in 0-RTT
            allowed_methods ["GET", "HEAD"]
            // Reject 0-RTT for authenticated requests
            reject_authenticated true
        }
    }
}

// Upstreams
upstreams {
    upstream "api-backend" {
        // Upstream servers
        targets [
            { address "10.0.1.10:8080" weight 1 }
            { address "10.0.1.11:8080" weight 1 }
        ]

        // Health checks work across all protocols
        health_check {
            check_type { http { path "/health" } }
            interval_secs 5
            timeout_secs 2
        }

        // Connection pooling
        connection_pool {
            // Separate pools for different protocols
            http3 {
                max_connections 100
                max_idle 50
                idle_timeout_secs 30
            }
            http2 {
                max_connections 100
                max_idle 50
                idle_timeout_secs 60
            }
            http1 {
                max_connections 200
                max_idle 100
                idle_timeout_secs 120
            }
        }
    }

    upstream "webtransport-backend" {
        targets [
            { address "10.0.2.10:8080" weight 1 }
        ]

        // WebTransport requires HTTP/3
        protocols ["h3"]
    }
}

// Monitoring and observability
observability {
    metrics {
        enabled true
        address "0.0.0.0:9090"
        path "/metrics"

        // HTTP/3 specific metrics
        http3_metrics {
            enabled true

            // Track these metrics
            track [
                "connections_established"
                "connections_migrated"
                "0rtt_accepted"
                "0rtt_rejected"
                "packets_sent"
                "packets_received"
                "packets_lost"
                "bytes_sent"
                "bytes_received"
                "streams_opened"
                "streams_closed"
                "rtt_samples"
                "congestion_events"
                "quic_version_negotiation"
            ]

            // Detailed connection metrics
            connection_details true

            // Stream-level metrics
            stream_metrics true
        }
    }

    logging {
        level "info"

        // QUIC/HTTP3 debug logging
        quic_debug {
            enabled false  // Enable for troubleshooting

            // Log categories
            log_packets false
            log_frames false
            log_congestion true
            log_recovery true
            log_handshake true
            log_migration true
        }
    }

    tracing {
        backend { jaeger { endpoint "http://localhost:14268/api/traces" } }
        sampling_rate 0.01

        // Trace HTTP/3 specific events
        http3_tracing {
            trace_0rtt true
            trace_migration true
            trace_congestion true
            trace_stream_events true
        }
    }
}

// Global HTTP/3 settings
http3_global {
    // Fallback behavior when HTTP/3 fails
    fallback {
        enabled true
        // Fallback order
        protocols ["h2", "http/1.1"]
        // Retry HTTP/3 after fallback
        retry_after_secs 300  // 5 minutes
    }

    // Version negotiation
    version_negotiation {
        // Supported QUIC versions
        versions ["1", "draft-29"]
        // Preferred version
        preferred "1"
    }

    // Security settings
    security {
        // Require address validation for new connections
        require_address_validation true

        // Stateless reset
        stateless_reset {
            enabled true
            key_rotation_interval_secs 86400  // Daily
        }

        // Retry tokens
        retry {
            enabled true
            token_lifetime_secs 30
        }
    }

    // Experimental features
    experimental {
        // Multipath QUIC
        multipath false

        // Quantum-resistant key exchange
        quantum_resistant false

        // ECN (Explicit Congestion Notification)
        enable_ecn false
    }
}
