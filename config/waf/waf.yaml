# Sentinel WAF Agent Configuration
# This configuration file controls the WAF agent behavior and ModSecurity engine settings

# ModSecurity engine configuration
engine:
  # Enable/disable the WAF engine
  enabled: true

  # Detection only mode - log but don't block
  detection_only: false

  # ModSecurity version (v2 or v3)
  version: "v3"

  # Enable request body inspection
  request_body_access: true

  # Enable response body inspection (performance impact)
  response_body_access: false

  # Debug log level (0-9, higher = more verbose)
  debug_level: 0

  # OWASP CRS paranoia level (1-4)
  # 1 = Low false positives, basic protection
  # 2 = Balanced protection
  # 3 = More false positives, better protection
  # 4 = Highest protection, many false positives
  paranoia_level: 1

  # Anomaly scoring threshold (lower = stricter)
  anomaly_threshold: 5

  # Enable PCRE JIT compilation for better performance
  pcre_jit: true

# Rules configuration
rules:
  # Load OWASP Core Rule Set
  load_crs: true

  # CRS version
  crs_version: "4.0.0"

  # Path to CRS rules (auto-detected if not specified)
  # crs_path: /usr/share/modsecurity-crs

  # Additional custom rules files to load
  custom_rules_files:
    # - /etc/sentinel/waf/custom-rules.conf
    # - /etc/sentinel/waf/site-specific.conf

  # Inline custom rules
  custom_rules:
    # Block specific user agents
    - |
      SecRule REQUEST_HEADERS:User-Agent "@contains BadBot" \
        "id:100001,\
        phase:1,\
        block,\
        msg:'Blocked bad bot',\
        logdata:'Matched user agent: %{REQUEST_HEADERS.User-Agent}',\
        severity:'NOTICE',\
        tag:'custom-rule'"

  # Exclude specific rule IDs
  exclude_rule_ids:
    # - 920350  # Host header is IP address
    # - 930120  # OS file access attempt

  # Exclude rules by tag
  exclude_rule_tags:
    # - "attack-sqli"
    # - "attack-xss"

  # Enable hot reload of rules
  hot_reload: true

  # Rule reload check interval (seconds)
  reload_interval_seconds: 60

# Body inspection configuration
body_inspection:
  # Maximum request body size to inspect (bytes)
  max_request_body_size: 10485760  # 10MB

  # Maximum response body size to inspect (bytes)
  max_response_body_size: 10485760  # 10MB

  # Request body buffer limit (bytes)
  request_body_buffer_limit: 1048576  # 1MB

  # Response body buffer limit (bytes)
  response_body_buffer_limit: 1048576  # 1MB

  # Content types to inspect for requests
  inspect_request_content_types:
    - "application/x-www-form-urlencoded"
    - "multipart/form-data"
    - "application/json"
    - "application/xml"
    - "text/xml"
    - "application/soap+xml"
    - "text/plain"

  # Content types to inspect for responses
  inspect_response_content_types:
    - "text/html"
    - "application/json"
    - "application/xml"
    - "text/xml"

  # Enable request body decompression
  decompress_request: true

  # Enable response body decompression
  decompress_response: false

  # Maximum decompression ratio (prevent zip bombs)
  max_decompression_ratio: 100

  # Enable multipart/form-data parsing
  parse_multipart: true

  # Enable JSON parsing
  parse_json: true

  # Enable XML parsing
  parse_xml: true

# Audit logging configuration
audit:
  # Enable audit logging
  enabled: true

  # Audit log directory
  log_dir: /var/log/sentinel-waf

  # Log all transactions (verbose)
  log_all: false

  # Log only relevant transactions (with alerts)
  log_relevant: true

  # Include request headers in audit log
  include_request_headers: true

  # Include request body in audit log
  include_request_body: false

  # Include response headers in audit log
  include_response_headers: true

  # Include response body in audit log
  include_response_body: false

  # Maximum audit log file size (bytes)
  max_file_size: 104857600  # 100MB

  # Audit log format (json, native, or concurrent)
  format: json

  # Include rule metadata in logs
  include_rule_metadata: true

# Performance tuning
performance:
  # Maximum number of concurrent transactions
  max_concurrent_transactions: 10000

  # Transaction pool size
  transaction_pool_size: 1000

  # Enable request caching (experimental)
  enable_request_cache: false

  # Request cache size (number of entries)
  request_cache_size: 10000

  # Cache TTL in seconds
  cache_ttl_seconds: 300

  # Enable rule optimizations
  optimize_rules: true

  # Worker threads for async operations
  worker_threads: 4

  # Request processing timeout (milliseconds)
  request_timeout_ms: 5000

# Exclusions and exceptions
exclusions:
  # Example: Exclude health check endpoint
  - name: "health-check"
    description: "Exclude health check endpoint from WAF"
    enabled: true
    bypass_waf: true
    conditions:
      - type: path
        pattern: "/health"
        regex: false

  # Example: Reduce protection for admin IPs
  - name: "admin-network"
    description: "Reduce false positives for admin network"
    enabled: false
    bypass_waf: false
    exclude_rule_tags:
      - "attack-sqli"
      - "attack-xss"
    conditions:
      - type: client_ip
        value: "10.0.0.0/8"

  # Example: Exclude specific API endpoint
  - name: "upload-endpoint"
    description: "Exclude file upload endpoint"
    enabled: false
    bypass_waf: false
    exclude_rule_ids:
      - 200002  # File upload limits
    conditions:
      - type: path
        pattern: "^/api/v1/upload"
        regex: true
      - type: method
        value: "POST"

# Agent listener configuration
listener:
  # Unix socket path
  socket_path: /var/run/sentinel/waf.sock

  # Socket permissions (octal)
  socket_permissions: 0660

  # Socket owner user (optional)
  # socket_user: sentinel

  # Socket owner group (optional)
  # socket_group: sentinel

  # Maximum concurrent connections
  max_connections: 1000

  # Connection timeout (milliseconds)
  connection_timeout_ms: 5000

  # Read buffer size (bytes)
  buffer_size: 65536

# Metrics configuration
metrics:
  # Enable metrics endpoint
  enabled: true

  # Metrics port
  port: 9094

  # Bind address
  bind_address: "127.0.0.1"

  # Include detailed per-rule metrics
  detailed_rule_metrics: false

  # Metrics path
  path: "/metrics"
