// API Routes Configuration
// This file defines all API-related routes and their handling rules

routes {
    // Public API endpoints
    route "api-public" {
        priority "high"

        matches {
            path-prefix "/api/v1/public"
            method "GET" "POST" "PUT" "DELETE" "PATCH"
        }

        upstream "api-backend-v1"

        policies {
            timeout-secs 30
            max-body-size "10MB"
            failure-mode "open"

            request-headers {
                set {
                    "X-Route-Id" "api-public-v1"
                }
                remove "X-Internal-Token" "X-Debug-Mode"
            }

            response-headers {
                set {
                    "Access-Control-Allow-Origin" "*"
                    "Access-Control-Allow-Methods" "GET, POST, PUT, DELETE, OPTIONS"
                    "Access-Control-Allow-Headers" "Content-Type, Authorization"
                }
            }

            cache {
                enabled #true
                ttl-secs 300
                vary-headers "Accept" "Accept-Encoding"
            }
        }

        filters "rate-limiter" "cors-handler"
    }

    // Authenticated API endpoints
    route "api-authenticated" {
        priority "high"

        matches {
            path-prefix "/api/v1/user"
            method "GET" "POST" "PUT" "DELETE" "PATCH"
        }

        upstream "api-backend-v1"

        // Authentication and protection filters
        filters "auth-jwt" "rate-limiter" "waf"

        policies {
            timeout-secs 45
            max-body-size "50MB"
            failure-mode "closed"

            request-headers {
                set {
                    "X-Route-Id" "api-authenticated"
                }
            }
        }

        circuit-breaker {
            failure-threshold 5
            success-threshold 2
            timeout-seconds 30
            half-open-max-requests 3
        }

        retry-policy {
            max-attempts 3
            timeout-ms 5000
            backoff-base-ms 100
            backoff-max-ms 2000
            retryable-status-codes 502 503 504
        }
    }

    // WebSocket API endpoint
    route "websocket-api" {
        priority "normal"

        matches {
            path-prefix "/api/v1/ws"
            header "Upgrade" "websocket"
        }

        upstream "websocket-backend"

        policies {
            timeout-secs 3600  // 1 hour for WebSocket
            buffer-requests #false
            buffer-responses #false
        }

        filters "auth-jwt"
    }

    // Admin API (internal only)
    route "admin-api" {
        priority "normal"

        matches {
            path-prefix "/admin/api"
            method "GET" "POST" "PUT" "DELETE"
        }

        upstream "admin-backend"

        filters "auth-mtls" "audit-logger" "waf"

        policies {
            timeout-secs 60
            max-body-size "100MB"
            failure-mode "closed"
        }
    }

    // Health check endpoint (builtin handler)
    route "health" {
        priority "critical"

        matches {
            path "/health"
            method "GET"
        }

        builtin-handler "health"

        policies {
            timeout-secs 5
            failure-mode "open"
        }
    }

    // Metrics endpoint (builtin handler)
    route "metrics" {
        priority "critical"

        matches {
            path "/metrics"
            method "GET"
        }

        builtin-handler "metrics"

        policies {
            timeout-secs 5
            failure-mode "open"
        }

        filters "auth-basic"
    }

    // API documentation (static files)
    route "api-docs" {
        priority "normal"

        matches {
            path-prefix "/api/docs"
            method "GET"
        }

        service-type "static"

        static-files {
            root "/var/www/api-docs"
            index "index.html"
            spa-fallback #true
        }

        policies {
            timeout-secs 10
            response-headers {
                set {
                    "Cache-Control" "public, max-age=3600"
                }
            }
        }
    }

    // Catch-all for undefined API routes
    route "api-404" {
        priority "low"

        matches {
            path-prefix "/api"
        }

        builtin-handler "not-found"

        policies {
            failure-mode "open"
        }
    }
}
