#!/usr/bin/env bash
#MISE description="Show comprehensive documentation statistics"

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘    Sentinel Documentation Statistics       â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Navigate to book directory
cd book

# Basic file statistics
echo -e "${CYAN}${BOLD}ğŸ“ File Statistics:${NC}"
TOTAL_MD=$(find src -name "*.md" -type f | wc -l | tr -d ' ')
TOTAL_DIRS=$(find src -type d | wc -l | tr -d ' ')
echo -e "${YELLOW}  Total Markdown files:${NC} ${GREEN}${TOTAL_MD}${NC}"
echo -e "${YELLOW}  Total directories:${NC} ${GREEN}${TOTAL_DIRS}${NC}"

# Content statistics
echo
echo -e "${CYAN}${BOLD}ğŸ“Š Content Statistics:${NC}"
TOTAL_LINES=$(find src -name "*.md" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
TOTAL_WORDS=$(find src -name "*.md" -exec wc -w {} + 2>/dev/null | tail -1 | awk '{print $1}')
TOTAL_CHARS=$(find src -name "*.md" -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}')
echo -e "${YELLOW}  Total lines:${NC} ${GREEN}$(printf "%'d" ${TOTAL_LINES})${NC}"
echo -e "${YELLOW}  Total words:${NC} ${GREEN}$(printf "%'d" ${TOTAL_WORDS})${NC}"
echo -e "${YELLOW}  Total characters:${NC} ${GREEN}$(printf "%'d" ${TOTAL_CHARS})${NC}"

if [ ${TOTAL_LINES} -gt 0 ]; then
    AVG_LINES=$((TOTAL_LINES / TOTAL_MD))
    AVG_WORDS=$((TOTAL_WORDS / TOTAL_MD))
    echo -e "${YELLOW}  Average lines per file:${NC} ${GREEN}${AVG_LINES}${NC}"
    echo -e "${YELLOW}  Average words per file:${NC} ${GREEN}${AVG_WORDS}${NC}"
fi

# Structure statistics from SUMMARY.md
echo
echo -e "${CYAN}${BOLD}ğŸ“š Documentation Structure:${NC}"
if [ -f src/SUMMARY.md ]; then
    CHAPTERS=$(grep -c '^# ' src/SUMMARY.md 2>/dev/null || echo "0")
    MAIN_SECTIONS=$(grep -c '^- \[' src/SUMMARY.md 2>/dev/null || echo "0")
    SUB_SECTIONS=$(grep -c '^  - \[' src/SUMMARY.md 2>/dev/null || echo "0")
    SUB_SUB_SECTIONS=$(grep -c '^    - \[' src/SUMMARY.md 2>/dev/null || echo "0")

    echo -e "${YELLOW}  Chapter headers:${NC} ${GREEN}${CHAPTERS}${NC}"
    echo -e "${YELLOW}  Main sections:${NC} ${GREEN}${MAIN_SECTIONS}${NC}"
    echo -e "${YELLOW}  Sub-sections:${NC} ${GREEN}${SUB_SECTIONS}${NC}"
    echo -e "${YELLOW}  Sub-sub-sections:${NC} ${GREEN}${SUB_SUB_SECTIONS}${NC}"
    echo -e "${YELLOW}  Total entries:${NC} ${GREEN}$((MAIN_SECTIONS + SUB_SECTIONS + SUB_SUB_SECTIONS))${NC}"
fi

# Code block statistics
echo
echo -e "${CYAN}${BOLD}ğŸ’» Code Examples:${NC}"
CODE_BLOCKS=$(find src -name "*.md" -exec grep -c '```' {} + 2>/dev/null | awk '{sum+=$1} END {print sum/2}' | cut -d. -f1)
RUST_BLOCKS=$(find src -name "*.md" -exec grep -c '```rust' {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
KDL_BLOCKS=$(find src -name "*.md" -exec grep -c '```kdl' {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
BASH_BLOCKS=$(find src -name "*.md" -exec grep -c '```bash' {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')
YAML_BLOCKS=$(find src -name "*.md" -exec grep -c '```yaml' {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')

echo -e "${YELLOW}  Total code blocks:${NC} ${GREEN}${CODE_BLOCKS:-0}${NC}"
[ "${RUST_BLOCKS:-0}" -gt 0 ] && echo -e "${YELLOW}    Rust examples:${NC} ${GREEN}${RUST_BLOCKS}${NC}"
[ "${KDL_BLOCKS:-0}" -gt 0 ] && echo -e "${YELLOW}    KDL configs:${NC} ${GREEN}${KDL_BLOCKS}${NC}"
[ "${BASH_BLOCKS:-0}" -gt 0 ] && echo -e "${YELLOW}    Bash commands:${NC} ${GREEN}${BASH_BLOCKS}${NC}"
[ "${YAML_BLOCKS:-0}" -gt 0 ] && echo -e "${YELLOW}    YAML configs:${NC} ${GREEN}${YAML_BLOCKS}${NC}"

# Section-specific statistics
echo
echo -e "${CYAN}${BOLD}ğŸ“‚ Section Breakdown:${NC}"
for dir in getting-started concepts configuration service-types features advanced deployment operations reference examples development appendix; do
    if [ -d "src/$dir" ]; then
        COUNT=$(find "src/$dir" -name "*.md" -type f | wc -l | tr -d ' ')
        if [ "$COUNT" -gt 0 ]; then
            WORDS=$(find "src/$dir" -name "*.md" -exec wc -w {} + 2>/dev/null | tail -1 | awk '{print $1}')
            printf "${YELLOW}  %-20s${NC} ${GREEN}%2d files${NC} ${MAGENTA}(%'d words)${NC}\n" "$dir:" "$COUNT" "$WORDS"
        fi
    fi
done

# Build statistics (if built)
if [ -d "book" ]; then
    echo
    echo -e "${CYAN}${BOLD}ğŸ—ï¸  Build Statistics:${NC}"
    HTML_FILES=$(find book -name "*.html" -type f 2>/dev/null | wc -l | tr -d ' ')
    BUILD_SIZE=$(du -sh book 2>/dev/null | cut -f1)
    echo -e "${YELLOW}  HTML files generated:${NC} ${GREEN}${HTML_FILES}${NC}"
    echo -e "${YELLOW}  Build size:${NC} ${GREEN}${BUILD_SIZE}${NC}"

    # Check for largest files
    echo -e "${YELLOW}  Largest HTML files:${NC}"
    find book -name "*.html" -type f -exec du -h {} + 2>/dev/null | sort -rh | head -3 | while read size file; do
        filename=$(basename "$file")
        printf "    ${GREEN}%-10s${NC} %s\n" "$size" "$filename"
    done
else
    echo
    echo -e "${MAGENTA}â„¹ï¸  Documentation not built yet. Run 'mise run book-build' to build.${NC}"
fi

# Links and references
echo
echo -e "${CYAN}${BOLD}ğŸ”— Links & References:${NC}"
INTERNAL_LINKS=$(find src -name "*.md" -exec grep -o '\[.*\](.*.md)' {} \; 2>/dev/null | wc -l | tr -d ' ')
EXTERNAL_LINKS=$(find src -name "*.md" -exec grep -o '\[.*\](http[s]*://.*)' {} \; 2>/dev/null | wc -l | tr -d ' ')
HEADINGS=$(find src -name "*.md" -exec grep -c '^#' {} + 2>/dev/null | awk '{sum+=$1} END {print sum}')

echo -e "${YELLOW}  Internal links:${NC} ${GREEN}${INTERNAL_LINKS}${NC}"
echo -e "${YELLOW}  External links:${NC} ${GREEN}${EXTERNAL_LINKS}${NC}"
echo -e "${YELLOW}  Total headings:${NC} ${GREEN}${HEADINGS}${NC}"

# Completion status (check for TODO markers)
echo
echo -e "${CYAN}${BOLD}âœ… Completion Status:${NC}"
TODO_COUNT=$(find src -name "*.md" -exec grep -i "TODO\|FIXME\|XXX\|HACK" {} \; 2>/dev/null | wc -l | tr -d ' ')
EMPTY_FILES=$(find src -name "*.md" -exec sh -c 'test $(wc -l < "$1") -le 1' _ {} \; -print 2>/dev/null | wc -l | tr -d ' ')

if [ "$TODO_COUNT" -eq 0 ] && [ "$EMPTY_FILES" -eq 0 ]; then
    echo -e "${GREEN}  âœ“ No TODO markers found${NC}"
    echo -e "${GREEN}  âœ“ No empty files${NC}"
else
    [ "$TODO_COUNT" -gt 0 ] && echo -e "${YELLOW}  âš  TODO markers found:${NC} ${RED}${TODO_COUNT}${NC}"
    [ "$EMPTY_FILES" -gt 0 ] && echo -e "${YELLOW}  âš  Empty/stub files:${NC} ${RED}${EMPTY_FILES}${NC}"
fi

# Show files that need content
if [ "$EMPTY_FILES" -gt 0 ]; then
    echo -e "${YELLOW}  Files needing content:${NC}"
    find src -name "*.md" -exec sh -c 'test $(wc -l < "$1") -le 1' _ {} \; -print 2>/dev/null | head -5 | while read file; do
        echo -e "${RED}    - ${file#src/}${NC}"
    done
    if [ "$EMPTY_FILES" -gt 5 ]; then
        echo -e "${YELLOW}    ... and $((EMPTY_FILES - 5)) more${NC}"
    fi
fi

echo
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
