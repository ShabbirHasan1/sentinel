#!/usr/bin/env bash
#MISE description="Create a new documentation page with template"
#MISE env={PATH="", SECTION="", TITLE="", TEMPLATE="basic"}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

# Function to display usage
usage() {
    echo -e "${BLUE}${BOLD}Usage:${NC}"
    echo -e "  ${YELLOW}mise run book-new-page PATH=<path> [TITLE=\"<title>\"] [SECTION=<section>] [TEMPLATE=<template>]${NC}"
    echo
    echo -e "${BLUE}${BOLD}Parameters:${NC}"
    echo -e "  ${YELLOW}PATH${NC}      - Required. Path to the new page (e.g., 'guides/my-guide.md')"
    echo -e "  ${YELLOW}TITLE${NC}     - Optional. Page title (defaults to filename-based title)"
    echo -e "  ${YELLOW}SECTION${NC}   - Optional. Section in SUMMARY.md to add the page to"
    echo -e "  ${YELLOW}TEMPLATE${NC}  - Optional. Template type: basic, guide, reference, api (default: basic)"
    echo
    echo -e "${BLUE}${BOLD}Examples:${NC}"
    echo -e "  ${GREEN}mise run book-new-page PATH=guides/docker-setup.md${NC}"
    echo -e "  ${GREEN}mise run book-new-page PATH=reference/api/endpoints.md TITLE=\"API Endpoints\"${NC}"
    echo -e "  ${GREEN}mise run book-new-page PATH=examples/nginx-migration.md TEMPLATE=guide${NC}"
    exit 1
}

# Function to convert filename to title
filename_to_title() {
    local filename="$1"
    # Remove .md extension, replace hyphens/underscores with spaces, capitalize words
    echo "$filename" | sed 's/\.md$//' | sed 's/[-_]/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1'
}

# Function to generate template content
generate_template() {
    local template_type="$1"
    local title="$2"
    local path="$3"

    case "$template_type" in
        guide)
            cat <<EOF
# ${title}

## Overview

This guide covers [topic description here].

## Prerequisites

Before you begin, ensure you have:

- Requirement 1
- Requirement 2
- Requirement 3

## Steps

### Step 1: [First Step Title]

[Describe the first step]

\`\`\`bash
# Example command
example command here
\`\`\`

### Step 2: [Second Step Title]

[Describe the second step]

### Step 3: [Third Step Title]

[Describe the third step]

## Configuration Example

\`\`\`kdl
// Example configuration
example {
    setting "value"
}
\`\`\`

## Verification

To verify the setup:

1. Check step 1
2. Verify step 2
3. Confirm step 3

## Troubleshooting

### Common Issue 1

**Problem:** Description of the issue

**Solution:** How to fix it

### Common Issue 2

**Problem:** Description of the issue

**Solution:** How to fix it

## Next Steps

- Link to related guide
- Link to reference documentation
- Link to examples

## See Also

- [Related Topic 1](../related/topic1.md)
- [Related Topic 2](../related/topic2.md)
EOF
            ;;

        reference)
            cat <<EOF
# ${title}

## Description

[Provide a detailed description of this reference topic]

## Syntax

\`\`\`
syntax here
\`\`\`

## Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| \`param1\` | string | Yes | - | Description of parameter 1 |
| \`param2\` | integer | No | 0 | Description of parameter 2 |
| \`param3\` | boolean | No | false | Description of parameter 3 |

## Options

### Option 1

Description of option 1.

### Option 2

Description of option 2.

## Examples

### Basic Example

\`\`\`kdl
// Basic usage
example {
    parameter "value"
}
\`\`\`

### Advanced Example

\`\`\`kdl
// Advanced usage with multiple options
example {
    parameter1 "value1"
    parameter2 123
    nested {
        option true
    }
}
\`\`\`

## Notes

- Important note 1
- Important note 2
- Important note 3

## Compatibility

- Version 0.1.0+: Full support
- Version 0.0.x: Limited support

## See Also

- [Related Reference](./related.md)
- [Configuration Guide](../configuration/overview.md)
EOF
            ;;

        api)
            cat <<EOF
# ${title}

## Endpoint

\`\`\`
METHOD /path/to/endpoint
\`\`\`

## Description

[Describe what this API endpoint does]

## Authentication

This endpoint requires [authentication method].

## Request

### Headers

| Header | Required | Description |
|--------|----------|-------------|
| \`Content-Type\` | Yes | Must be \`application/json\` |
| \`Authorization\` | Yes | Bearer token |

### Parameters

#### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| \`id\` | string | The resource ID |

#### Query Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| \`limit\` | integer | No | 10 | Maximum number of results |
| \`offset\` | integer | No | 0 | Number of results to skip |

### Request Body

\`\`\`json
{
  "field1": "string",
  "field2": 123,
  "field3": {
    "nested": "value"
  }
}
\`\`\`

## Response

### Success Response

**Code:** 200 OK

**Content:**

\`\`\`json
{
  "status": "success",
  "data": {
    "id": "123",
    "field1": "value1",
    "field2": 456
  }
}
\`\`\`

### Error Responses

**Code:** 400 Bad Request

**Content:**

\`\`\`json
{
  "status": "error",
  "error": {
    "code": "INVALID_REQUEST",
    "message": "Description of the error"
  }
}
\`\`\`

## Examples

### cURL

\`\`\`bash
curl -X GET \\
  https://api.example.com/endpoint \\
  -H "Authorization: Bearer YOUR_TOKEN" \\
  -H "Content-Type: application/json"
\`\`\`

### Rust

\`\`\`rust
// Example using reqwest
let response = client
    .get("https://api.example.com/endpoint")
    .bearer_auth(token)
    .send()
    .await?;
\`\`\`

## Rate Limiting

This endpoint is rate limited to:
- 100 requests per minute per IP
- 1000 requests per hour per API key

## See Also

- [Authentication Guide](../authentication.md)
- [Error Codes Reference](../error-codes.md)
EOF
            ;;

        *)  # basic template
            cat <<EOF
# ${title}

## Overview

[Provide a brief introduction to this topic]

## Description

[Detailed description goes here]

## Examples

### Example 1

[Describe the example]

\`\`\`kdl
// Example code or configuration
example {
    setting "value"
}
\`\`\`

### Example 2

[Describe another example]

## Configuration

[Describe any configuration options]

## Best Practices

- Best practice 1
- Best practice 2
- Best practice 3

## Common Use Cases

1. Use case 1
2. Use case 2
3. Use case 3

## Related Topics

- [Related Topic 1](../related/topic1.md)
- [Related Topic 2](../related/topic2.md)

## See Also

- [Reference Documentation](../reference/index.md)
- [Configuration Guide](../configuration/overview.md)
EOF
            ;;
    esac
}

# Check if PATH is provided
if [ -z "${PATH}" ] || [ "${PATH}" == "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" ]; then
    echo -e "${RED}Error: PATH parameter is required${NC}"
    echo
    usage
fi

# Navigate to book source directory
cd book/src

# Clean up the path (remove leading/trailing slashes, ensure .md extension)
DOC_PATH="${PATH#/}"
DOC_PATH="${DOC_PATH%/}"

# Ensure .md extension
if [[ ! "$DOC_PATH" =~ \.md$ ]]; then
    DOC_PATH="${DOC_PATH}.md"
fi

# Check if file already exists
if [ -f "$DOC_PATH" ]; then
    echo -e "${YELLOW}⚠ File already exists: ${DOC_PATH}${NC}"
    read -p "Do you want to overwrite it? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}✗ Aborted${NC}"
        exit 1
    fi
fi

# Create directory structure if needed
DOC_DIR=$(dirname "$DOC_PATH")
if [ "$DOC_DIR" != "." ] && [ ! -d "$DOC_DIR" ]; then
    mkdir -p "$DOC_DIR"
    echo -e "${GREEN}✓ Created directory: ${DOC_DIR}${NC}"
fi

# Generate title if not provided
if [ -z "${TITLE}" ]; then
    FILENAME=$(basename "$DOC_PATH")
    TITLE=$(filename_to_title "$FILENAME")
fi

# Set default template
TEMPLATE=${TEMPLATE:-basic}

echo -e "${BLUE}Creating new documentation page...${NC}"
echo -e "${YELLOW}  Path:${NC} ${DOC_PATH}"
echo -e "${YELLOW}  Title:${NC} ${TITLE}"
echo -e "${YELLOW}  Template:${NC} ${TEMPLATE}"

# Generate and write the content
generate_template "$TEMPLATE" "$TITLE" "$DOC_PATH" > "$DOC_PATH"

echo -e "${GREEN}✓ Created documentation page: ${DOC_PATH}${NC}"

# Ask about adding to SUMMARY.md
echo
read -p "Would you like to add this page to SUMMARY.md? (Y/n) " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    echo -e "${YELLOW}Adding to SUMMARY.md...${NC}"

    # Determine the section and indentation level based on path
    IFS='/' read -ra PATH_PARTS <<< "$DOC_PATH"
    DEPTH=${#PATH_PARTS[@]}

    # Create the link entry
    INDENT=""
    for ((i=1; i<DEPTH; i++)); do
        INDENT="  ${INDENT}"
    done
    LINK_ENTRY="${INDENT}- [${TITLE}](./${DOC_PATH})"

    if [ -n "${SECTION}" ]; then
        # Try to add under specific section
        echo -e "${YELLOW}  Looking for section: ${SECTION}${NC}"

        # This is simplified - in production you'd want more sophisticated section detection
        if grep -q "^#.*${SECTION}" SUMMARY.md; then
            # Add after the section header
            sed -i "/^#.*${SECTION}/a\\${LINK_ENTRY}" SUMMARY.md
            echo -e "${GREEN}✓ Added to ${SECTION} section in SUMMARY.md${NC}"
        else
            # Append to end if section not found
            echo "$LINK_ENTRY" >> SUMMARY.md
            echo -e "${YELLOW}⚠ Section '${SECTION}' not found, appended to end of SUMMARY.md${NC}"
        fi
    else
        # Try to add in appropriate location based on path
        PARENT_DIR=$(dirname "$DOC_PATH")
        if [ "$PARENT_DIR" != "." ]; then
            # Look for other entries in the same directory
            if grep -q "${PARENT_DIR}/" SUMMARY.md; then
                # Add after the last entry in this directory
                LAST_LINE=$(grep -n "${PARENT_DIR}/" SUMMARY.md | tail -1 | cut -d: -f1)
                sed -i "${LAST_LINE}a\\${LINK_ENTRY}" SUMMARY.md
                echo -e "${GREEN}✓ Added to SUMMARY.md after other ${PARENT_DIR}/ entries${NC}"
            else
                # Append to end
                echo "$LINK_ENTRY" >> SUMMARY.md
                echo -e "${GREEN}✓ Appended to end of SUMMARY.md${NC}"
            fi
        else
            # Root level file, append to end
            echo "$LINK_ENTRY" >> SUMMARY.md
            echo -e "${GREEN}✓ Appended to end of SUMMARY.md${NC}"
        fi
    fi

    echo -e "${YELLOW}  Note: You may need to manually adjust the position in SUMMARY.md${NC}"
else
    echo -e "${YELLOW}ℹ Remember to add this page to SUMMARY.md manually:${NC}"
    echo -e "${CYAN}  - [${TITLE}](./${DOC_PATH})${NC}"
fi

echo
echo -e "${GREEN}✓ Documentation page created successfully!${NC}"
echo -e "${BLUE}Next steps:${NC}"
echo -e "  1. Edit the content in: ${CYAN}book/src/${DOC_PATH}${NC}"
echo -e "  2. Preview your changes: ${CYAN}mise run book-serve${NC}"
echo -e "  3. Build the documentation: ${CYAN}mise run book-build${NC}"
