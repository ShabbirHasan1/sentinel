#!/usr/bin/env bash
#MISE description="Install mdBook via mise and optional plugins"
#MISE env={INSTALL_PLUGINS="false"}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║   Installing mdBook for Documentation  ║${NC}"
echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
echo

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Install mdbook via mise
echo -e "${YELLOW}→ Installing mdBook via mise...${NC}"

# Run mise install to ensure mdbook is installed
if mise install mdbook; then
    echo -e "${GREEN}✓ mdBook installed via mise${NC}"
else
    echo -e "${RED}✗ Failed to install mdBook via mise${NC}"
    echo -e "${YELLOW}  Ensure mdbook is listed in mise.toml [tools] section${NC}"
    exit 1
fi

# Verify mdbook is available
if command_exists mdbook; then
    MDBOOK_VERSION=$(mdbook --version 2>/dev/null | cut -d' ' -f2)
    echo -e "${GREEN}✓ mdBook ${MDBOOK_VERSION} is available${NC}"
else
    echo -e "${YELLOW}⚠ mdBook installed but not in PATH${NC}"
    echo -e "${YELLOW}  Try running: mise reshim${NC}"
    echo -e "${YELLOW}  Or: eval \"\$(mise activate bash)\"${NC}"
fi

# Install optional plugins if requested
if [[ "${INSTALL_PLUGINS}" == "true" ]]; then
    echo
    echo -e "${YELLOW}→ Installing optional mdBook plugins...${NC}"

    # Check if cargo is available
    if command_exists cargo; then
        echo -e "${CYAN}  Note: These plugins require cargo and are installed globally${NC}"

        # Install plugins (allow failures for individual plugins)
        plugins=(
            "mdbook-mermaid"
            "mdbook-admonish"
            "mdbook-linkcheck"
            "mdbook-toc"
            "mdbook-katex"
            "mdbook-plantuml"
            "mdbook-open-on-gh"
        )

        for plugin in "${plugins[@]}"; do
            echo -e "${YELLOW}  Installing ${plugin}...${NC}"
            if cargo install "$plugin" 2>/dev/null; then
                echo -e "${GREEN}    ✓ ${plugin} installed${NC}"
            else
                echo -e "${YELLOW}    ⚠ ${plugin} installation failed (optional)${NC}"
            fi
        done

        echo -e "${GREEN}✓ Plugin installation complete${NC}"
    else
        echo -e "${YELLOW}⚠ Cargo not found. Cannot install optional plugins.${NC}"
        echo -e "${YELLOW}  Plugins require Rust/Cargo to be installed.${NC}"
    fi
fi

echo
echo -e "${GREEN}✓ mdBook setup complete!${NC}"
echo -e "${BLUE}Next steps:${NC}"
echo -e "  • Build docs: ${CYAN}mise run book-build${NC}"
echo -e "  • Serve docs: ${CYAN}mise run book-serve${NC}"
echo -e "  • View stats: ${CYAN}mise run book-stats${NC}"

# Show mise tool info
echo
echo -e "${BLUE}mdBook installation info:${NC}"
mise list mdbook 2>/dev/null || echo -e "${YELLOW}  Run 'mise list' to see installed tools${NC}"
