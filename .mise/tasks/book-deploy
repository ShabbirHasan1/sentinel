#!/usr/bin/env bash
#MISE description="Deploy documentation to GitHub Pages"
#MISE depends=["book-build"]
#MISE env={FORCE_PUSH="false", CNAME="", MESSAGE=""}

set -e

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m' # No Color

cd "$(dirname "$0")/../.." # Navigate to project root

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Deploying Documentation to GitHub    â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check if git is available
if ! command -v git &> /dev/null; then
    echo -e "${RED}Error: git is not installed${NC}"
    exit 1
fi

# Check if we're in a git repository
if [ ! -d .git ]; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Get repository information
REPO_URL=$(git config --get remote.origin.url)
if [ -z "$REPO_URL" ]; then
    echo -e "${RED}Error: No remote origin configured${NC}"
    exit 1
fi

# Convert SSH URL to HTTPS if needed for display
DISPLAY_URL=$(echo "$REPO_URL" | sed 's/git@github.com:/https:\/\/github.com\//' | sed 's/\.git$//')

echo -e "${CYAN}Repository:${NC} ${DISPLAY_URL}"
echo -e "${CYAN}Current branch:${NC} $(git branch --show-current)"
echo

# Check if mdbook exists
if ! command -v mdbook &> /dev/null; then
    echo -e "${RED}Error: mdBook is not installed${NC}"
    echo -e "${YELLOW}Run 'mise run book-install' to install mdBook${NC}"
    exit 1
fi

# Build the documentation
echo -e "${YELLOW}â†’ Building documentation...${NC}"
cd book
mdbook build

if [ ! -d "book" ]; then
    echo -e "${RED}âœ— Documentation build failed${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ Documentation built successfully${NC}"

# Prepare deployment directory
DEPLOY_DIR=$(mktemp -d)
trap "rm -rf $DEPLOY_DIR" EXIT

echo -e "${YELLOW}â†’ Preparing deployment...${NC}"

# Copy built documentation to temporary directory
cp -r book/* "$DEPLOY_DIR/"

# Add CNAME file if specified
if [ -n "$CNAME" ]; then
    echo "$CNAME" > "$DEPLOY_DIR/CNAME"
    echo -e "${GREEN}âœ“ Added CNAME file: ${CNAME}${NC}"
fi

# Add .nojekyll file to prevent GitHub from processing with Jekyll
touch "$DEPLOY_DIR/.nojekyll"

# Initialize git in deployment directory
cd "$DEPLOY_DIR"
git init
git add .

# Set commit message
if [ -z "$MESSAGE" ]; then
    MESSAGE="Deploy documentation - $(date '+%Y-%m-%d %H:%M:%S')"
fi

git commit -m "$MESSAGE"

echo -e "${YELLOW}â†’ Deploying to GitHub Pages...${NC}"

# Check if gh-pages branch exists on remote
cd "$OLDPWD"
if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
    echo -e "${CYAN}  gh-pages branch exists${NC}"
    BRANCH_EXISTS=true
else
    echo -e "${YELLOW}  gh-pages branch will be created${NC}"
    BRANCH_EXISTS=false
fi

# Push to gh-pages branch
cd "$DEPLOY_DIR"

# Configure git for CI environments
if [ -n "$CI" ]; then
    git config user.name "GitHub Actions"
    git config user.email "actions@github.com"
elif [ -z "$(git config --get user.name)" ] || [ -z "$(git config --get user.email)" ]; then
    echo -e "${YELLOW}Git user not configured. Using defaults.${NC}"
    git config user.name "Documentation Deploy"
    git config user.email "docs@sentinel.local"
fi

# Add remote
git remote add origin "$REPO_URL"

# Force push to gh-pages branch
if [ "$FORCE_PUSH" == "true" ] || [ "$BRANCH_EXISTS" == "false" ]; then
    echo -e "${YELLOW}  Force pushing to gh-pages branch...${NC}"
    git push -f origin HEAD:gh-pages
else
    # Try regular push first, fall back to force if needed
    echo -e "${YELLOW}  Pushing to gh-pages branch...${NC}"
    if ! git push origin HEAD:gh-pages; then
        echo -e "${YELLOW}  Regular push failed, attempting force push...${NC}"
        read -p "Force push to gh-pages? This will overwrite the remote branch. (y/N) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git push -f origin HEAD:gh-pages
        else
            echo -e "${RED}âœ— Deployment cancelled${NC}"
            exit 1
        fi
    fi
fi

echo -e "${GREEN}âœ“ Documentation deployed successfully!${NC}"
echo

# Determine the documentation URL
if echo "$REPO_URL" | grep -q "github.com"; then
    # Extract owner and repo name
    if [[ "$REPO_URL" =~ github.com[:/]([^/]+)/([^/.]+) ]]; then
        OWNER="${BASH_REMATCH[1]}"
        REPO="${BASH_REMATCH[2]}"

        # Check if this is a user/org pages repo (username.github.io)
        if [[ "$REPO" == "${OWNER}.github.io" ]]; then
            DOC_URL="https://${OWNER}.github.io/"
        else
            # Project pages
            if [ -n "$CNAME" ]; then
                DOC_URL="https://${CNAME}/"
            else
                DOC_URL="https://${OWNER}.github.io/${REPO}/"
            fi
        fi

        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘         Deployment Information             â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo
        echo -e "${GREEN}ğŸ“š Documentation URL:${NC}"
        echo -e "${CYAN}   ${DOC_URL}${NC}"
        echo
        echo -e "${YELLOW}â„¹ï¸  Notes:${NC}"
        echo -e "${YELLOW}   â€¢ It may take a few minutes for changes to appear${NC}"
        echo -e "${YELLOW}   â€¢ Ensure GitHub Pages is enabled in repository settings${NC}"
        echo -e "${YELLOW}   â€¢ Pages should be configured to deploy from gh-pages branch${NC}"

        if [ -z "$CNAME" ]; then
            echo
            echo -e "${MAGENTA}ğŸ’¡ Tip:${NC}"
            echo -e "${MAGENTA}   To use a custom domain, set CNAME environment variable:${NC}"
            echo -e "${MAGENTA}   CNAME=docs.example.com mise run book-deploy${NC}"
        fi
    fi
else
    echo -e "${GREEN}âœ“ Documentation deployed to gh-pages branch${NC}"
    echo -e "${YELLOW}Configure your git hosting service to serve from the gh-pages branch${NC}"
fi

echo
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
